---
bibliography: biblio.bib
csl: styles.ref/nature.csl
output:
  bookdown::word_document2:
    reference_docx: styles.doc/NIH_grant_style.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.height = 6,fig.width = 6,eval.after = "fig.cap")
load(file = 'ACR_HMM/fit.R')
#load(file = 'fit/fit2.R')
library(bayesplot)
library(rstan)
library(ggpubr)
s <- summary(hmm_fit, probs = c(0.025, 0.975))
mu1<-formatC(s$summary[5,1],format="f",digits=2)
mu1_95<-paste(formatC(s$summary[5,4], format="f", digits=2),",",formatC(s$summary[5,5], format="f", digits=2))
```

# Identifying cognitive impairment in patients with SLE using Hidden Markov models: A Bayesian approach

# Introduction

Cognitive impairment (CI) constitutes one of the most common manifestations of the neuropsychiatric syndromes experienced by patients living with Systemic lupus erythematosus (SLE), with a prevalence of 38% (95% confidence interval: 33-43%) [@al2018prevalence]. Conventional screening/diagnostic tools for CI in SLE patients take into account the scores generated by neuropsychological batteries like the American College of Rheumatology Neuropsychological Battery (ACR-NB).

ACR-NB evaluates these cognitive domains: Manual motor speed and dexterity, simple attention and processing speed, visual-spatial construction, verbal fluency, learning and memory, executive functioning and assesses estimated pre-morbid IQ. Patient scores are compared to a normative sample of age- and gender-matched healthy controls to obtain z-scores. CI is **usually** operationalized on the battery as a z-score of ≤-1.5 (as compared to controls) on ≥2 domains or z ≤-2.0 on ≥1 domain.

Given the complexity of diagnosing CI in SLE patients, there is an unmet need to identify the best screening, diagnostic metrics of CI and furthermore the assessment of cognitive function over time. Therefore we propose a new framework which uses the continous z-scores derived from the ACR-NB over time based on Hidden Markov Models (HMMs) to address the aforementioned challenges for classifing SLE patients into CI vs non CI-groups. In other words, our model aims to classify SLE patientes into one of these 2 groups using the observed z-scores from the battery.

# Methods

The study population consisted of 301 consecutive SLE patients followed at the Lupus Clinic-Cognitive Study, who consented to participate and to be assessed for CI. All 301 SLE patients were assessed at baseline using the comprehensive ACR-NB and 187 patients also completed visits at 6 months and at 12 months.

Instead of using the binary operalization of the scores of ACR-NB, we developed a new approach to facilitate the interpretability of the ACR-NB using continuous scores. The **first step** reduces the high-dimensional aspect of the ACR-NB tests using principal component analysis (PCA) with the objective to create a single component score which explains the most variance (i.e. first component). The **second step** builds a 2-state cognitive status based on the discrete-time HMM with the dimensionality reduction gained in the first step using PCA. The HMM proposed in this study assumes that the change of the component score over timein patients with SLE can be segmented into 2 distinct cognitive states, where each state captures if a patient is cognitively impaired or not at time t, using the component score obtained at each time point. We assumed that the component score is Normal with unknown mean and variance, and the mean and variance are different between the two hidden states (being cognitively impaired or not). Additionally, we specified that the mean of the Normal outcome depends linearly on education level; this adjustment means that the hidden states will capture the unobserved heterogeneity not explained after controlling by education level. All the statistical analysis was done from a Bayesian perspective using the probabilistic programming language `Stan` through `R` which implements the Hamiltonian Markov Chain Monte Carlo method.


# Results

Figure \@ref(fig:fig0) shows the results of the PCA where patients’ component scores are coloured by ACR-NB CI binary definition (turqoise for CI and orange for non-CI). It is clear that the 1st dimension separated patients with CI from those with non-CI at baseline. Moreover, it shows that the second dimension was mainly explained by measures of simple information processing or motor speed. The estimated mean for the CI state was `r formatC(s$summary[5,1],format="f",digits=2)` (95% CrI: `r paste(formatC(s$summary[5,4], format="f", digits=2),",",formatC(s$summary[5,5], format="f", digits=2))`) and `r formatC(s$summary[6,1],format="f",digits=2)` (95% CrI: `r paste(formatC(s$summary[6,4], format="f", digits=2),",",formatC(s$summary[6,5], format="f", digits=2))`) for the non-CI state, meaning that for example we expect that our model will classify a patient as impaired if its observed component score lies on the area of `mu[1]` (see Figure \@ref(fig:fig1)). Finally, we did not find evidence that education level was associated with the component score (Figure \@ref(fig:fig1)). 


# Conclusions

To our knowlegdge this is the first analysis which aimed to classify patients with SLE as cognitive impaired or not over time in a unsupervised way, meaning that it only relies on the observed z-scores from the 19 tests on the ACR-NB and not on the binary classification. We found the probability of changing between states is low (Figure \@ref(fig:fig2)), meaning that it is difficult that patients move between states over time. Future research should try to collect more data points in order to study the changes between them for a longer period of time.

```{r fig0,echo=FALSE,fig.cap="Biplot at baseline. Axis x represents the first component (explaining 28.3% of the variance) and axis y represents the second dimension. The length of each arrow represents the strength of the relationship between the variable it represents, and the cognitive components found in our PCA'. The angle between variables represents the strength of the correlation between them.",warning=F}
impairment+theme_pubr(legend = "bottom")+theme(axis.title.x = element_text(face="bold"),axis.title.y = element_text(face="bold"))
```


```{r fig1,message=F,echo=FALSE,fig.cap=paste('Posterior densities. Y axis represents the parameters were inference is made. X axis represents the distribution of the parameters of interest. The dark shaded region region represnts the point estimate from a frequentist point of view and the ligth shaded region represents the 95% uncertainty interval, i.e., with 95% of probability the estimate would lie in that region. As an example mu[1] represents the inference made on the unknown mean of the observed component score given that it comes from the CI state  after adjusting for education level. The point estimate is',mu1,'with 95 % CrI','(',mu1_95,').'),warning=F}
color_scheme_set("mix-red-pink")
mcmc_areas(
  hmm_fit,
  pars = c("mu[1]", "mu[2]", "alpha[1]","alpha[2]",
           'alpha[3]',"alpha[4]"),
  prob = 0.95, # 80% interva
  prob_outer = 0.99, # 99%
  point_est = "mean"
)+labs(
   title = "Posterior distributions of mu[1], mu[2] and education level parameters",
   subtitle = "with means and 95% intervals"
 )+theme_pubr(legend = "right")+theme(axis.title.x = element_text(face="bold"),axis.title.y = element_text(face="bold"))+
  scale_y_discrete(labels=c("alpha[1]" = "Grade 8",
                            "alpha[2]" = "High school",
                            "alpha[3]" = "College",
                            "alpha[4]" = "University","mu[1]" = "mu[1]",
                            "mu[2]" = "mu[2]"))
```


```{r fig2,echo=FALSE,warning=F,fig.cap="Posterior uncertainty intervals for the transition probabilities in our HMM. Over discrete time points, P11 is the probability of remaining in the CI state, P12 is the probability of moving from the CI state to the non state and so on. The dot on the graph represents the point estimate and the line the 95% CrI.",message=F}
mcmc_intervals(hmm_fit, regex_pars = "theta",point_est = "mean",prob = 0.5,
  prob_outer = .99)+labs(
   title = "Uncertainty intervals for transition probabilities",
   subtitle = "with means and 95% intervals"
 )+theme_pubr(legend = "right")+theme(axis.title.x = element_text(face="bold"),axis.title.y = element_text(face="bold"))+
  scale_y_discrete(labels=c("theta[1,1]" = expression(P[11]),
                            "theta[1,2]" =expression(P[12]),
                            "theta[2,1]" =expression(P[21]),
                            "theta[2,2]" = expression(P[22]) ))
```


# References
